<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AquaConnect — Marketplace + Wallet + Live Tracking (NGN)</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

<style>
  :root{
    --bg:#f4f7fb; --card:#fff; --accent:#0b67d0; --muted:#667085; --success:#16a34a; --danger:#e11d48; --text:#081128; --radius:10px;
    font-family:Inter,system-ui,Arial,sans-serif;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  header{background:var(--card);padding:10px;border-bottom:1px solid #eef3fb;display:flex;align-items:center;justify-content:space-between;gap:12px;position:sticky;top:0;z-index:10}
  header h1{margin:0;font-size:18px}
  .container{max-width:1100px;margin:12px auto;padding:12px}
  .card{background:var(--card);padding:12px;border-radius:var(--radius);box-shadow:0 6px 20px rgba(11,22,40,0.04);margin-bottom:12px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .small{font-size:13px;color:var(--muted)}
  input,select,textarea,button{font-family:inherit;font-size:14px}
  input,select,textarea{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #e6eef8}
  textarea{min-height:80px;resize:vertical}
  .btn{background:var(--accent);color:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,103,208,0.12)}
  .btn.warn{background:var(--danger)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eef3fb;text-align:left;font-size:13px}
  img.thumb{width:64px;height:64px;object-fit:cover;border-radius:8px}
  .badge{display:inline-block;background:var(--success);color:white;padding:4px 8px;border-radius:12px;font-size:12px}
  .list-card{background:#fff;padding:10px;border-radius:10px;margin-bottom:8px;box-shadow:0 6px 18px rgba(11,22,40,0.03)}
  .nav-bottom{display:none;position:fixed;inset:auto 0 0 0;height:56px;background:var(--card);border-top:1px solid #eef3fb;display:flex;gap:6px;align-items:center;justify-content:space-around;padding:6px}
  .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:999;align-items:center;justify-content:center}
  .modal{background:var(--card);border-radius:10px;padding:12px;width:92%;max-width:900px;max-height:90vh;overflow:auto}
  /* map */
  #map{height:360px;border-radius:8px}
  /* order colors */
  .order-card.pending{background:linear-gradient(90deg,#fff7d6,#fff);border-left:4px solid #f7c948}
  .order-card.accepted{background:linear-gradient(90deg,#ecfdf5,#fff);border-left:4px solid #10b981}
  .order-card.rejected{background:linear-gradient(90deg,#ffeaea,#fff);border-left:4px solid #ef4444}
  .order-card.delivered{background:linear-gradient(90deg,#eef2ff,#fff);border-left:4px solid #7c3aed}
  /* responsive */
  @media (max-width:980px){ .grid{grid-template-columns:1fr;gap:10px} .nav-bottom{display:flex} }
  @media (max-width:720px){ .container{padding:8px} .card{padding:10px} #map{height:260px} .modal{width:100%;height:100%;border-radius:0} }
  .wallet-card{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#f8fbff);box-shadow:0 6px 20px rgba(11,22,40,0.04)}
  .wallet-photo{width:64px;height:64px;border-radius:12px;background:#eef3fb;overflow:hidden}
  .wallet-main{flex:1}
  .wallet-name{font-weight:700;font-size:16px}
  .wallet-amount{font-weight:800;font-size:20px;color:var(--accent);margin-top:6px}
  .wallet-type{font-size:12px;color:var(--muted)}
  .wallet-actions{display:flex;flex-direction:column;gap:6px}
  .tx-list{max-height:200px;overflow:auto;margin-top:8px}
  .tx-item{display:flex;justify-content:space-between;padding:8px 6px;border-bottom:1px dashed #eef3fb}
  .tx-credit{color:var(--success)}
  .tx-debit{color:var(--danger)}
  .product-images{display:flex;gap:8px;flex-wrap:wrap}
  .product-images img{width:140px;height:100px;object-fit:cover;border-radius:8px}
  .search-suggestions{position:relative}
  .suggest-list{position:absolute;left:0;right:0;top:44px;background:white;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.08);z-index:20;max-height:220px;overflow:auto}
  .suggest-item{padding:8px;border-bottom:1px solid #f1f5f9;cursor:pointer}
  .suggest-item:hover{background:#f8fbff}
</style>
</head>
<body>
<header>
  <h1>AquaConnect — Marketplace & Wallet (NGN)</h1>
  <div id="sessionBox" class="small">Not signed in</div>
</header>

<div class="container">
  <div id="root"></div>
  <div class="small" style="margin-top:8px">Data stored in <code>localStorage</code> keys: <code>lb_users</code>, <code>lb_products</code>, <code>lb_orders</code>, <code>lb_badge_requests</code>. Currency: NGN (₦).</div>
</div>

<!-- bottom nav for mobile -->
<nav class="nav-bottom" id="mobileNav">
  <button class="btn ghost" onclick="navTo('home')">Home</button>
  <button class="btn ghost" onclick="navTo('products')">Products</button>
  <button class="btn ghost" onclick="navTo('orders')">Orders</button>
  <button class="btn ghost" onclick="navTo('profile')">Profile</button>
</nav>

<!-- product / vendor modal (in-page) -->
<div id="productModal" class="modal-backdrop">
  <div class="modal" id="productModalCard">
    <div style="display:flex;gap:12px;align-items:center">
      <div id="pmVendorPhoto" class="wallet-photo"></div>
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:8px">
          <div id="pmVendorName" style="font-weight:700"></div>
          <div id="pmVendorBadge"></div>
        </div>
        <div class="small" id="pmVendorDesc"></div>
        <div style="margin-top:6px">Rating: <span id="pmVendorRating">0.0</span> ★</div>
      </div>
      <div><button class="btn ghost" onclick="closeProductModal()">Close</button></div>
    </div>
    <hr/>
    <div>
      <h3 id="pmProductName">Product</h3>
      <div class="product-images" id="pmProductImages"></div>
      <div style="margin-top:8px;font-weight:700" id="pmProductPrice"></div>
      <div class="small" id="pmProductVendorInfo"></div>
      <div style="margin-top:10px"><button class="btn" id="pmBuyBtn">Buy</button></div>
    </div>
    <hr/>
    <h4>Reviews</h4>
    <div id="pmReviews"></div>
  </div>
</div>

<!-- map modal -->
<div id="mapModal" class="modal-backdrop">
  <div class="modal">
    <div style="display:flex;gap:8px;align-items:center">
      <strong id="mapTitle">Tracking</strong>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="mapRefresh" class="btn">Refresh</button>
        <button id="mapStop" class="btn ghost">Stop Live</button>
        <button id="mapClose" class="btn ghost">Close</button>
      </div>
    </div>
    <div id="map" style="margin-top:8px"></div>
    <div class="tiny" style="margin-top:8px">Markers update live while the user has allowed location sharing in this browser session.</div>
  </div>
</div>

<!-- confirm modal -->
<div id="confirmModal" class="modal-backdrop">
  <div class="modal">
    <p id="confirmText"></p>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button id="confirmYes" class="btn">Continue</button>
      <button id="confirmNo" class="btn ghost">Cancel</button>
    </div>
  </div>
</div>

<!-- pay modal -->
<div id="payModal" class="modal-backdrop">
  <div class="modal">
    <h3 id="payTitle">Top-up Wallet</h3>
    <div class="small" id="payDesc">Simulated payment (dummy).</div>
    <form id="payForm">
      <label class="small">Card number</label><input id="payCard" placeholder="4242 4242 4242 4242" required />
      <label class="small">Expiry (MM/YY)</label><input id="payExp" placeholder="MM/YY" required />
      <label class="small">CVV</label><input id="payCvv" placeholder="123" required />
      <label class="small">Amount (NGN)</label><input id="payAmount" type="number" min="1" placeholder="1000" required />
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
        <button class="btn" type="submit">Submit</button>
        <button class="btn ghost" type="button" onclick="closePayModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- rating modal -->
<div id="ratingModal" class="modal-backdrop">
  <div class="modal" style="max-width:480px">
    <h3>Rate Vendor</h3>
    <div class="small" id="ratingVendorInfo"></div>
    <label class="small">Stars (1-5)</label>
    <input id="ratingStars" type="number" min="1" max="5" value="5"/>
    <label class="small">Comment</label>
    <textarea id="ratingComment"></textarea>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
      <button class="btn" id="ratingSubmit">Submit</button>
      <button class="btn ghost" onclick="closeRatingModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- profile modal for admin -->
<div id="profileModal" class="modal-backdrop">
  <div class="modal" style="max-width:900px">
    <div style="display:flex;gap:12px;align-items:center">
      <div id="profilePhoto" class="wallet-photo"></div>
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:8px">
          <div id="profileName" style="font-weight:700"></div>
          <div id="profileBadge"></div>
        </div>
        <div class="small" id="profileEmail"></div>
        <div class="small" id="profileRole"></div>
      </div>
      <div><button class="btn ghost" onclick="closeProfileModal()">Close</button></div>
    </div>
    <hr/>
    <div style="display:flex;gap:12px">
      <div style="flex:1">
        <h4>Details</h4>
        <div id="profileDesc" class="small"></div>
        <div style="margin-top:8px"><strong>Balance:</strong> <span id="profileBalance"></span></div>
        <div style="margin-top:8px"><strong>Password:</strong> <span id="profilePasswordMasked"></span> <button class="btn ghost" id="togglePasswordBtn">Toggle</button></div>
        <div style="margin-top:12px">
          <h4>Orders</h4>
          <div id="profileOrders"></div>
        </div>
        <div style="margin-top:12px">
          <h4>Admin Adjust (credit / debit)</h4>
          <div style="display:flex;gap:8px">
            <input id="profileAdjAmount" placeholder="Amount (+ credit, - debit)" />
            <button class="btn" id="profileAdjBtn">Apply</button>
          </div>
        </div>
      </div>
      <div style="width:320px">
        <h4>Transactions</h4>
        <div id="profileTransactions" style="max-height:320px;overflow:auto"></div>
        <div style="margin-top:12px">
          <h4>Certificate & Face Verification</h4>
          <div id="profileCertificate" class="small"></div>
          <div style="margin-top:8px"><strong>Face Verification Image:</strong><div id="profileFace" class="small"></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
/* ===========================
   AquaConnect single-file app
   ===========================
   - localStorage-only backend
   - Admin seeded: admin@aquaconnet / admin123
   - NGN currency for money formatting
   - Leaflet + OSM for tracking
*/

/* ---------- Config & Storage Keys ---------- */
const K_USERS = 'lb_users', K_PRODUCTS = 'lb_products', K_ORDERS = 'lb_orders', K_BADGE = 'lb_badge_requests';
const ADMIN_EMAIL = 'admin@aquaconnet', ADMIN_PASS = 'admin123';

/* ---------- Helpers ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const rand = p => (p||'id') + '_' + Math.random().toString(36).slice(2,9);
const fmtNGN = n => new Intl.NumberFormat('en-NG',{style:'currency',currency:'NGN',maximumFractionDigits:2}).format(Number(n)||0);
const escapeHtml = str => String(str||'').replace(/[&<>\"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]);

/* ---------- Storage seed/load ---------- */
let users = JSON.parse(localStorage.getItem(K_USERS) || 'null') || [
  { id:'admin1', name:'Admin', email: ADMIN_EMAIL, password: ADMIN_PASS, role:'admin', balance:0, badge:false, requests:[], reviews:[], profile:{photo:null, desc:''}, cert:null, face:null, transactions:[], registeredAt: Date.now() }
];
let products = JSON.parse(localStorage.getItem(K_PRODUCTS) || 'null') || [];
let orders = JSON.parse(localStorage.getItem(K_ORDERS) || 'null') || [];
let badgeRequests = JSON.parse(localStorage.getItem(K_BADGE) || 'null') || [];
let session = null; // {userId}
const liveWatchers = { vendor: {}, customer: {} }; // in-memory geolocation watch ids

function persist(){
  localStorage.setItem(K_USERS, JSON.stringify(users));
  localStorage.setItem(K_PRODUCTS, JSON.stringify(products));
  localStorage.setItem(K_ORDERS, JSON.stringify(orders));
  localStorage.setItem(K_BADGE, JSON.stringify(badgeRequests));
}

/* find helpers */
function findUserByEmail(email){ return users.find(u=>u.email.toLowerCase()===String(email||'').toLowerCase()); }
function getUserById(id){ return users.find(u=>u.id===id); }

/* transaction helper */
function addTransaction(email, type, amount, note){
  const u = findUserByEmail(email);
  if(!u) return;
  u.transactions = u.transactions || [];
  u.transactions.unshift({ id: rand('tx'), ts: Date.now(), type, amount: Number(amount), note: note||'' });
  persist();
}

/* ---------- UI: Auth ---------- */
function renderAuth(){
  $('#sessionBox').textContent = 'Not signed in';
  document.getElementById('mobileNav').style.display = window.innerWidth <= 720 ? 'flex' : 'none';
  const html = `
  <div class="grid">
    <div>
      <div class="card">
        <h3>Register</h3>
        <form id="regForm">
          <input id="regName" placeholder="Full name" required />
          <input id="regEmail" type="email" placeholder="Email" required />
          <input id="regPass" type="password" placeholder="Password" required />
          <select id="regRole"><option value="customer">Customer</option><option value="vendor">Vendor</option></select>
          <div id="vendorExtra" style="display:none;margin-top:8px">
            <label class="small">Profile Photo (optional)</label>
            <input id="regPhoto" type="file" accept="image/*" />
            <label class="small">Short Description</label>
            <textarea id="regDesc" placeholder="Describe your business"></textarea>
            <label class="small">Certificate (for verification)</label>
            <input id="regCert" type="file" accept="image/*,application/pdf" />
            <label class="small">Face verification (selfie)</label>
            <input id="regFace" type="file" accept="image/*" />
          </div>
          <div style="display:flex;gap:8px;margin-top:10px"><button class="btn">Register</button><button id="regReset" type="button" class="btn ghost">Reset</button></div>
        </form>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Login (Vendor/Customer)</h3>
        <form id="loginForm">
          <input id="logEmail" type="email" placeholder="Email" required />
          <input id="logPass" type="password" placeholder="Password" required />
          <div style="display:flex;gap:8px;margin-top:10px"><button class="btn">Login</button><button id="guestBtn" type="button" class="btn ghost">Guest (customer)</button></div>
        </form>
      </div>
    </div>

    <div>
      <div class="card">
        <h3>Admin Login</h3>
        <form id="adminForm">
          <input id="adminEmail" type="email" placeholder="Admin email" required />
          <input id="adminPass" type="password" placeholder="Password" required />
          <div style="display:flex;gap:8px;margin-top:10px"><button class="btn">Admin Login</button><button id="showData" type="button" class="btn ghost">Show Raw</button></div>
        </form>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Demo Tips</h3>
        <ul class="small">
          <li>Admin: <strong>${ADMIN_EMAIL}</strong> / <strong>${ADMIN_PASS}</strong></li>
          <li>Vendors upload photo, certificate & face for verification.</li>
          <li>Allow location to demo live tracking.</li>
        </ul>
      </div>
    </div>
  </div>
  `;
  $('#root').innerHTML = html;

  $('#regRole').onchange = ()=>{ $('#vendorExtra').style.display = $('#regRole').value === 'vendor' ? 'block' : 'none'; };

  $('#regForm').onsubmit = async e=>{
    e.preventDefault();
    const name = $('#regName').value.trim();
    const email = $('#regEmail').value.trim().toLowerCase();
    const pass = $('#regPass').value;
    const role = $('#regRole').value;
    if(findUserByEmail(email)) return alert('Email exists');
    let photo = null, cert = null, face = null, desc = '';
    if(role==='vendor'){
      const f = $('#regPhoto').files[0]; if(f) photo = await fileToBase64(f);
      const c = $('#regCert').files[0]; if(c) cert = await fileToBase64(c);
      const ff = $('#regFace').files[0]; if(ff) face = await fileToBase64(ff);
      desc = $('#regDesc').value.trim();
    }
    const user = { id: rand('u'), name, email, password: pass, role, balance:0, badge:false, requests:[], reviews:[], profile:{photo, desc}, cert, face, status: cert ? 'cert_submitted' : 'no_cert', transactions: [], registeredAt: Date.now() };
    users.push(user); persist();
    alert('Registered — please login.');
    $('#regForm').reset(); $('#vendorExtra').style.display='none';
  };
  $('#regReset').onclick = ()=>$('#regForm').reset();

  $('#loginForm').onsubmit = e=>{
    e.preventDefault();
    const email = $('#logEmail').value.trim().toLowerCase();
    const pass = $('#logPass').value;
    const u = users.find(x=>x.email===email && x.password===pass && x.role!=='admin');
    if(!u) return alert('Invalid credentials');
    session = { userId: u.id }; restoreLiveWatchers(); renderApp();
  };

  $('#guestBtn').onclick = ()=>{
    let g = users.find(u=>u.role==='customer');
    if(!g){
      g = { id:rand('u'), name:'Guest', email:'guest@localbank', password:'guest', role:'customer', balance:5000, badge:false, requests:[], reviews:[], profile:{photo:null, desc:''}, transactions: [], registeredAt: Date.now() };
      users.push(g); persist();
    }
    session = { userId: g.id }; restoreLiveWatchers(); renderApp();
  };

  $('#adminForm').onsubmit = e=>{
    e.preventDefault();
    const email = $('#adminEmail').value.trim().toLowerCase();
    const pass = $('#adminPass').value;
    const u = users.find(x=>x.email===email && x.password===pass && x.role==='admin');
    if(!u) return alert('Invalid admin credentials');
    session = { userId: u.id }; restoreLiveWatchers(); renderApp();
  };

  $('#showData').onclick = ()=>{ console.log({users,products,orders,badgeRequests}); alert('Check console for raw data'); };
}

/* ---------- Router / App ---------- */
function renderApp(){
  const me = getUserById(session.userId);
  if(!me) { session=null; return renderAuth(); }
  $('#sessionBox').textContent = `${me.name} — ${me.role} | Sign out`;
  $('#sessionBox').onclick = ()=>{ if(confirm('Sign out?')){ stopAllLiveWatchersForUser(me); session=null; renderAuth(); } };
  document.getElementById('mobileNav').style.display = window.innerWidth <= 720 ? 'flex' : 'none';
  if(me.role==='admin') renderAdmin(me);
  if(me.role==='vendor') renderVendor(me);
  if(me.role==='customer') renderCustomer(me);
}
function navTo(page){
  if(!session) return renderAuth();
  const me = getUserById(session.userId);
  if(!me) return renderAuth();
  if(me.role==='admin') renderAdmin(me);
  if(me.role==='vendor') renderVendor(me);
  if(me.role==='customer') renderCustomer(me);
}

/* ==================== Admin view ==================== */
function renderAdmin(admin){
  const html = `
  <div class="grid">
    <div>
      <div class="card">
        <h3>Users & Search</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
          <div style="flex:1;position:relative" class="search-suggestions">
            <input id="adminSearch" placeholder="Search by name or email" autocomplete="off" />
            <div id="suggestList" class="suggest-list" style="display:none"></div>
          </div>
          <button id="adminSearchBtn" class="btn ghost">Search</button>
        </div>
        <div class="small">Total users: ${users.length}</div>
        <div id="adminUsersList" style="margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Badge Request Queue</h3>
        <div id="badgeQueue"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Products</h3>
        <div id="adminProducts"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Orders</h3>
        <div id="adminOrders"></div>
      </div>
    </div>

    <div>
      <div class="card">
        <h3>Admin Wallet</h3>
        <div class="wallet-card">
          <div class="wallet-photo">${escapeHtml(admin.profile.photo? `<img src="${admin.profile.photo}" style="width:100%;height:100%;object-fit:cover"/>` : '')}</div>
          <div class="wallet-main">
            <div class="wallet-name">${escapeHtml(admin.name)}</div>
            <div class="wallet-amount">${fmtNGN(admin.balance)}</div>
            <div class="wallet-type small">Admin Wallet (5% commission)</div>
          </div>
          <div class="wallet-actions"><div class="tx-icon" onclick="showTransactionsModal('${admin.email}')">📜</div></div>
        </div>
        <div id="adminTransactionsPanel" class="transactions" style="display:none"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Account Adjust</h3>
        <form id="adminAdj">
          <input id="adjEmail" placeholder="User email" />
          <input id="adjAmt" type="number" placeholder="Amount (+ credit, - debit)" />
          <div style="display:flex;gap:8px;margin-top:8px"><button class="btn">Apply</button><button id="adminRefresh" type="button" class="btn ghost">Refresh</button></div>
        </form>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Admin Settings</h3>
        <form id="adminSettingsForm">
          <input id="admName" placeholder="Admin name" />
          <input id="admEmail" placeholder="Admin email" />
          <input id="admPass" type="password" placeholder="Admin password" />
          <div style="display:flex;gap:8px;margin-top:8px"><button class="btn">Save</button><button id="adminLoad" type="button" class="btn ghost">Load</button></div>
        </form>
      </div>
    </div>
  </div>
  `;
  $('#root').innerHTML = html;

  function renderUsersList(list){
    const out = list.map(u=>{
      const photo = u.profile && u.profile.photo ? `<img class="thumb" src="${u.profile.photo}"/>` : '-';
      return `<div class="list-card"><div style="display:flex;gap:12px;align-items:center"><div>${photo}</div><div><div style="font-weight:700">${escapeHtml(u.name)}</div><div class="small">${escapeHtml(u.email)}</div><div class="small">Role: ${u.role} • Balance: ${fmtNGN(u.balance)}</div></div><div style="margin-left:auto;display:flex;gap:8px"><button class="btn ghost" onclick="openProfileModal('${u.id}')">View</button> ${u.badge?'<span class="badge">Trusted</span>':''}</div></div></div>`;
    }).join('');
    $('#adminUsersList').innerHTML = out || '<div class="small">No users</div>';
  }
  renderUsersList(users);

  // search suggestions
  const sInput = $('#adminSearch');
  const suggestBox = $('#suggestList');
  sInput.oninput = ()=>{
    const q = sInput.value.trim().toLowerCase();
    if(!q){ suggestBox.style.display='none'; return; }
    const matches = users.filter(u=>u.name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q)).slice(0,8);
    suggestBox.innerHTML = matches.map(m=>`<div class="suggest-item" data-id="${m.id}" onclick="adminSelectSuggestion('${m.id}')">${escapeHtml(m.name)} — ${escapeHtml(m.email)}</div>`).join('') || '<div class="suggest-item">No results</div>';
    suggestBox.style.display = 'block';
  };

  window.adminSelectSuggestion = function(uid){
    const u = getUserById(uid);
    if(!u) return;
    sInput.value = u.name;
    suggestBox.style.display='none';
    openProfileModal(uid);
  };

  // badge queue render
  $('#badgeQueue').innerHTML = badgeRequests.length ? badgeRequests.map(r=>{
    const vendor = getUserById(r.vendorId) || {};
    return `<div class="list-card"><div style="display:flex;align-items:center;justify-content:space-between"><div><div style="font-weight:700">${escapeHtml(vendor.name || r.vendorEmail)}</div><div class="small">${escapeHtml(r.vendorEmail)} • ${new Date(r.ts).toLocaleString()}</div></div><div><button class="btn" onclick="adminApproveBadgeRequest('${r.id}')">Approve</button> <button class="btn ghost" onclick="adminRejectBadgeRequest('${r.id}')">Reject</button></div></div></div>`;
  }).join('') : '<div class="small">No badge requests</div>';

  $('#adminProducts').innerHTML = products.length ? products.map(p=>`<div class="list-card"><div style="display:flex;align-items:center;gap:10px"><div>${p.images && p.images[0] ? `<img class="thumb" src="${p.images[0]}"/>` : '-'}</div><div><div style="font-weight:700">${escapeHtml(p.name)}</div><div class="small">${fmtNGN(p.price)} • ${escapeHtml(p.vendor)}</div></div></div></div>`).join('') : '<div class="small">No products</div>';

  $('#adminOrders').innerHTML = orders.length ? orders.map(o=>`<div class="list-card order-card ${o.status==='pending_vendor'?'pending':o.status==='accepted'?'accepted':o.status==='rejected'?'rejected':'delivered'}"><div style="display:flex;align-items:center;gap:10px"><div><div style="font-weight:700">${escapeHtml(o.product)}</div><div class="small">Customer: ${escapeHtml(o.customer)} • Vendor: ${escapeHtml(o.vendor)}</div><div class="small">Price: ${fmtNGN(o.price)} • ${o.status}</div></div><div style="margin-left:auto;">${o.status.startsWith('pending')?`<button class="btn" onclick="adminApprove('${o.id}')">Approve</button> <button class="btn ghost" onclick="adminReject('${o.id}')">Reject</button>`: `<button class="btn ghost" onclick="openMapForAdmin('${o.id}')">Track</button>`}</div></div></div>`).join('') : '<div class="small">No orders</div>';

  // actions
  $('#adminAdj').onsubmit = e=>{
    e.preventDefault();
    const email = $('#adjEmail').value.trim().toLowerCase();
    const amt = Number($('#adjAmt').value) || 0;
    const uu = findUserByEmail(email);
    if(!uu) return alert('User not found');
    uu.balance = Number((uu.balance + amt).toFixed(2));
    addTransaction(uu.email, amt>0?'credit':'debit', amt, 'Admin adjustment');
    persist();
    alert('Updated'); renderAdmin(admin);
  };
  $('#adminLoad').onclick = ()=>{
    const a = users.find(u=>u.role==='admin');
    if(!a) return alert('Admin not found');
    $('#admName').value = a.name; $('#admEmail').value = a.email; $('#admPass').value = a.password;
  };
  $('#adminSettingsForm').onsubmit = e=>{
    e.preventDefault();
    const a = users.find(u=>u.role==='admin');
    if(!a) return alert('Admin not found');
    const name = $('#admName').value.trim();
    const email = $('#admEmail').value.trim().toLowerCase();
    const pass = $('#admPass').value;
    if(!name || !email || !pass) return alert('All fields required');
    const conflict = users.find(u=>u.email===email && u.role!=='admin');
    if(conflict) return alert('Email already used');
    a.name = name; a.email = email; a.password = pass; persist();
    alert('Admin settings updated'); renderAdmin(a);
  };
  $('#adminRefresh').onclick = ()=>renderAdmin(admin);
  $('#adminSearchBtn').onclick = ()=>{ const q = $('#adminSearch').value.trim().toLowerCase(); const res = users.filter(u=>u.email.toLowerCase().includes(q) || u.name.toLowerCase().includes(q)); renderUsersList(res); };
}

/* admin badge request handlers */
function adminApproveBadgeRequest(reqId){
  const req = badgeRequests.find(r=>r.id===reqId); if(!req) return alert('Request not found');
  const v = getUserById(req.vendorId); if(!v) return alert('Vendor missing');
  v.badge = true; req.status = 'approved'; v.cert = null; v.status='verified'; persist();
  alert('Badge approved'); renderAdmin(getUserById(session.userId));
}
function adminRejectBadgeRequest(reqId){
  const req = badgeRequests.find(r=>r.id===reqId); if(!req) return alert('Request not found');
  req.status = 'rejected'; persist(); alert('Badge rejected'); renderAdmin(getUserById(session.userId));
}

/* open profile modal for admin */
function openProfileModal(userId){
  const u = getUserById(userId); if(!u) return alert('User not found');
  $('#profilePhoto').innerHTML = u.profile.photo ? `<img src="${u.profile.photo}" style="width:100%;height:100%;object-fit:cover"/>` : '<div style="width:100%;height:100%;background:#eee"></div>';
  $('#profileName').textContent = u.name; $('#profileBadge').innerHTML = u.badge ? '<span class="badge">Trusted</span>' : '';
  $('#profileEmail').textContent = u.email; $('#profileRole').textContent = `Role: ${u.role}`;
  $('#profileDesc').textContent = u.profile.desc || ''; $('#profileBalance').textContent = fmtNGN(u.balance);
  $('#profilePasswordMasked').textContent = '*'.repeat(String(u.password||'').length || 6);
  $('#profileRegistered').textContent = new Date(u.registeredAt || Date.now()).toLocaleString();
  $('#profileCertificate').innerHTML = u.cert ? `<a href="${u.cert}" target="_blank">View Certificate</a>` : '<div class="small">No certificate</div>';
  $('#profileFace').innerHTML = u.face ? `<img src="${u.face}" style="width:100%;height:auto;border-radius:6px;"/>` : '<div class="small">No face verification image</div>';
  const userOrders = orders.filter(o=>o.customer===u.email || o.vendor===u.email);
  $('#profileOrders').innerHTML = userOrders.length ? userOrders.map(o=>`<div class="list-card order-card ${o.status==='pending_vendor'?'pending':o.status==='accepted'?'accepted':o.status==='rejected'?'rejected':'delivered'}"><div style="font-weight:700">${escapeHtml(o.product)}</div><div class="small">${escapeHtml(o.customer)} ► ${escapeHtml(o.vendor)} • ${fmtNGN(o.price)} • ${o.status}</div></div>`).join('') : '<div class="small">No orders</div>';
  $('#profileTransactions').innerHTML = (u.transactions||[]).map(t=>`<div style="border-top:1px solid #eee;padding:6px"><div style="font-weight:700">${t.type.toUpperCase()}</div><div class="small">${new Date(t.ts).toLocaleString()}</div><div class="${t.amount<0?'tx-debit':'tx-credit'}">${fmtNGN(t.amount)}</div><div class="small">${escapeHtml(t.note||'')}</div></div>`).join('') || '<div class="small">No transactions</div>';
  $('#profileModal').style.display = 'flex';
  $('#togglePasswordBtn').onclick = ()=>{ const el = $('#profilePasswordMasked'); if(el.textContent[0]==='*') el.textContent = u.password; else el.textContent = '*'.repeat(u.password.length); };
  $('#profileAdjBtn').onclick = ()=>{ const amt = Number($('#profileAdjAmount').value) || 0; u.balance = Number((u.balance + amt).toFixed(2)); addTransaction(u.email, amt>0?'credit':'debit', amt, 'Admin profile adjustment'); persist(); alert('Adjusted'); openProfileModal(userId); };
}
function closeProfileModal(){ $('#profileModal').style.display = 'none'; }

/* ==================== Vendor view ==================== */
function renderVendor(vendor){
  const me = vendor;
  const html = `
    <div class="grid">
      <div>
        <div class="card">
          <h3>Vendor Profile</h3>
          <div style="display:flex;gap:12px;align-items:center">
            <div>${me.profile.photo?`<img class="thumb" src="${me.profile.photo}"/>`:'-'}</div>
            <div>
              <div style="font-weight:700">${escapeHtml(me.name)} ${me.badge? '<span class="badge">Trusted</span>':''}</div>
              <div class="small">${escapeHtml(me.profile.desc||'')}</div>
              <div class="small">Rating: ${getVendorRating(me)} ★</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Edit Profile</h3>
          <form id="vendorProfileForm">
            <label class="small">Profile Photo</label><input id="vpPhoto" type="file" accept="image/*" />
            <label class="small">Description</label><textarea id="vpDesc">${escapeHtml(me.profile.desc||'')}</textarea>
            <label class="small">Certificate (for verification)</label><input id="vpCert" type="file" accept="image/*,application/pdf" />
            <label class="small">Face verification (selfie)</label><input id="vpFace" type="file" accept="image/*" />
            <div style="display:flex;gap:8px;margin-top:8px"><button class="btn">Save</button><button id="reqBadge" type="button" class="btn ghost">Request Badge</button></div>
          </form>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Add Product (photos)</h3>
          <form id="prodForm">
            <input id="pName" placeholder="Product" required />
            <input id="pPrice" type="number" placeholder="Price (NGN)" required />
            <input id="pImages" type="file" accept="image/*" multiple />
            <div style="display:flex;gap:8px;margin-top:8px"><button class="btn">Add</button><button id="clearUpload" type="button" class="btn ghost">Clear</button></div>
          </form>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Your Products</h3>
          <div id="vendorProductsTbl"></div>
        </div>
      </div>

      <div>
        <div class="card">
          <h3>Wallet</h3>
          <div class="wallet-card">
            <div class="wallet-photo">${me.profile.photo?`<img src="${me.profile.photo}" style="width:100%;height:100%;object-fit:cover"/>`:''}</div>
            <div class="wallet-main">
              <div class="wallet-name">${escapeHtml(me.name)}</div>
              <div class="wallet-amount">${fmtNGN(me.balance)}</div>
              <div class="wallet-type small">Vendor Wallet</div>
            </div>
            <div class="wallet-actions">
              <button class="btn ghost" onclick="openPayModal('topup')">Top-up</button>
              <button class="btn ghost" onclick="openPayModal('withdraw')">Withdraw</button>
              <div style="margin-top:6px"><div class="tx-icon" onclick="showTransactionsModal('${me.email}')">📜</div></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Orders</h3>
          <div id="vendorOrdersTbl"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Verification & Badge</h3>
          <div class="small">Certificate status: ${me.status || 'none'}</div>
          <div class="small">Face verification uploaded: ${me.face? 'Yes' : 'No'}</div>
        </div>
      </div>
    </div>
  `;
  $('#root').innerHTML = html;

  // profile save
  $('#vendorProfileForm').onsubmit = async e=>{
    e.preventDefault();
    const f = $('#vpPhoto').files[0]; if(f) me.profile.photo = await fileToBase64(f);
    me.profile.desc = $('#vpDesc').value.trim();
    const c = $('#vpCert').files[0]; if(c){ me.cert = await fileToBase64(c); me.status='cert_submitted'; }
    const ff = $('#vpFace').files[0]; if(ff){ me.face = await fileToBase64(ff); }
    persist(); alert('Profile saved'); renderVendor(me);
  };
  $('#reqBadge').onclick = ()=>{
    if(!me.cert) return alert('Please upload certificate first');
    const req = { id: rand('br'), vendorId: me.id, vendorEmail: me.email, ts: Date.now(), status: 'pending' };
    badgeRequests.unshift(req); persist(); alert('Badge request sent to admin'); renderVendor(me);
  };

  // add product
  $('#prodForm').onsubmit = async e=>{
    e.preventDefault();
    const name = $('#pName').value.trim();
    const price = Number($('#pPrice').value) || 0;
    const files = $('#pImages').files;
    if(!name || !price) return alert('Name and price required');
    const imgs = [];
    for(let i=0;i<files.length;i++) imgs.push(await fileToBase64(files[i]));
    products.push({ id:rand('p'), name, price, images: imgs, vendor: me.email, description: '', createdAt: Date.now() });
    persist(); alert('Product added'); renderVendor(me);
  };
  $('#clearUpload').onclick = ()=>{ $('#pImages').value=''; $('#pName').value=''; $('#pPrice').value=''; };

  // render vendor products
  const my = products.filter(p=>p.vendor===me.email);
  $('#vendorProductsTbl').innerHTML = my.length ? my.map(p=>`<div class="list-card"><div style="display:flex;align-items:center;gap:8px"><div>${p.images[0]?`<img class="thumb" src="${p.images[0]}"/>`:'-'}</div><div><div style="font-weight:700">${escapeHtml(p.name)}</div><div class="small">${fmtNGN(p.price)}</div></div><div style="margin-left:auto;display:flex;gap:8px"><button class="btn ghost" onclick="openProductModal('${p.id}')">View</button> <button class="btn ghost" onclick="deleteProduct('${p.id}','${me.email}')">Delete</button></div></div></div>`).join('') : '<div class="small">No products</div>';

  // render vendor orders
  const vOrders = orders.filter(o=>o.vendor===me.email);
  $('#vendorOrdersTbl').innerHTML = vOrders.length ? vOrders.map(o=>{
    let actions = '';
    if(o.status==='pending_vendor') actions = `<button class="btn" onclick="vendorAccept('${o.id}')">Accept</button> <button class="btn ghost" onclick="vendorReject('${o.id}')">Reject</button>`;
    else if(o.status==='accepted') actions = `<button class="btn" onclick="markDelivered('${o.id}')">Mark Delivered</button>`;
    else actions = `<div class="small">${o.status}</div>`;
    return `<div class="list-card order-card ${o.status==='pending_vendor'?'pending':o.status==='accepted'?'accepted':o.status==='rejected'?'rejected':'delivered'}"><div style="display:flex;gap:10px;align-items:center"><div style="flex:1"><div style="font-weight:700">${escapeHtml(o.product)}</div><div class="small">Customer: ${escapeHtml(o.customer)}</div><div class="small">${fmtNGN(o.price)}</div></div><div style="display:flex;flex-direction:column;gap:6px">${actions} <button class="btn ghost" onclick="openMapForVendor('${o.id}')">Track</button></div></div></div>`;
  }).join('') : '<div class="small">No orders</div>';
}

/* vendor helpers */
function deleteProduct(pid, vendorEmail){
  const idx = products.findIndex(p=>p.id===pid && p.vendor===vendorEmail);
  if(idx>=0){ products.splice(idx,1); persist(); alert('Deleted'); const v=findUserByEmail(vendorEmail); renderVendor(v); }
}

/* vendor accept -> credit vendor 95%, admin 5% */
async function vendorAccept(orderId){
  const order = orders.find(o=>o.id===orderId); if(!order) return alert('Order not found');
  const vendorUser = findUserByEmail(order.vendor);
  const admin = users.find(u=>u.role==='admin');
  try{
    const loc = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
    order.vendorLocation = { lat:loc.coords.latitude, lng:loc.coords.longitude, ts:Date.now() };
    order.status = 'accepted'; persist();
    const vendorAmt = Number((order.price * 0.95).toFixed(2));
    const adminAmt = Number((order.price * 0.05).toFixed(2));
    vendorUser.balance = Number((vendorUser.balance + vendorAmt).toFixed(2));
    addTransaction(vendorUser.email,'credit', vendorAmt, `Sale (95%) - ${order.product}`);
    if(admin){ admin.balance = Number((admin.balance + adminAmt).toFixed(2)); addTransaction(admin.email,'credit', adminAmt, `Commission (5%) - ${order.product}`); }
    persist();
    startVendorLive(orderId);
    alert(`Order accepted. Vendor credited ${fmtNGN(vendorAmt)}. Admin credited ${fmtNGN(adminAmt)}.`);
    if(session && getUserById(session.userId).email === order.customer){ alert('Your order was accepted. Tracking available.'); renderCustomer(getUserById(session.userId)); }
    renderVendor(vendorUser);
  }catch(err){
    alert('Could not get vendor location. Accept aborted.');
  }
}

/* vendor reject -> refund and remove order */
function vendorReject(orderId){
  const order = orders.find(o=>o.id===orderId); if(!order) return alert('Order not found');
  const customer = findUserByEmail(order.customer);
  if(customer){ customer.balance = Number((customer.balance + order.price).toFixed(2)); addTransaction(customer.email,'credit', order.price, 'Refund (vendor rejected)'); }
  orders = orders.filter(o=>o.id!==orderId);
  persist();
  alert('Order rejected and customer refunded; order removed.');
  renderVendor(findUserByEmail(order.vendor));
  if(session && getUserById(session.userId).email===order.customer) alert('Your order was rejected and refunded.');
}

/* mark delivered */
function markDelivered(orderId){
  const order = orders.find(o=>o.id===orderId); if(!order) return alert('Order not found');
  order.status = 'delivered'; order.deliveredAt = new Date().toISOString(); persist();
  alert('Order marked delivered — customer may leave review');
  renderVendor(findUserByEmail(order.vendor));
}

/* ==================== Customer view ==================== */
function renderCustomer(customer){
  const me = customer;
  const html = `
    <div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="btn" id="tabProductsBtn">Available Products</button>
        <button class="btn ghost" id="tabOrdersBtn">Your Orders</button>
        <div style="margin-left:auto">
          <div class="wallet-card" style="align-items:center">
            <div class="wallet-photo">${me.profile.photo?`<img src="${me.profile.photo}" style="width:100%;height:100%;object-fit:cover"/>`:'<div style="width:100%;height:100%;background:#eee"></div>'}</div>
            <div class="wallet-main">
              <div class="wallet-name">${escapeHtml(me.name)}</div>
              <div class="wallet-amount">${fmtNGN(me.balance)}</div>
              <div class="wallet-type small">Customer Wallet</div>
            </div>
            <div class="wallet-actions">
              <button class="btn ghost" onclick="openPayModal('topup')">Top-up</button>
              <button class="btn ghost" onclick="openPayModal('withdraw')">Withdraw</button>
              <div style="margin-top:6px"><div class="tx-icon" onclick="showTransactionsModal('${me.email}')">📜</div></div>
            </div>
          </div>
        </div>
      </div>

      <div id="productsPanel" class="card">
        <h3>Available Products</h3>
        <div id="customerProducts"></div>
      </div>

      <div id="ordersPanel" class="card" style="display:none">
        <h3>Your Orders</h3>
        <div id="customerOrdersTbl"></div>
      </div>
    </div>
  `;
  $('#root').innerHTML = html;

  $('#tabProductsBtn').onclick = ()=>{ $('#productsPanel').style.display = 'block'; $('#ordersPanel').style.display = 'none'; };
  $('#tabOrdersBtn').onclick = ()=>{ $('#productsPanel').style.display = 'none'; $('#ordersPanel').style.display = 'block'; renderCustomerOrders(me); };

  // products listing
  $('#customerProducts').innerHTML = products.length ? products.map(p=>`<div class="list-card"><div style="display:flex;gap:8px;align-items:center"><div>${p.images && p.images[0] ? `<img class="thumb" src="${p.images[0]}"/>` : '-'}</div><div style="flex:1"><div style="font-weight:700">${escapeHtml(p.name)}</div><div class="small">${fmtNGN(p.price)} • ${escapeHtml(p.vendor)}</div></div><div style="display:flex;flex-direction:column;gap:8px"><button class="btn" onclick="openProductModal('${p.id}')">View</button><button class="btn ghost" onclick="initiatePurchaseFromList('${p.id}')">Buy</button></div></div></div>`).join('') : '<div class="small">No products</div>';

  renderCustomerOrders(me);
}

function renderCustomerOrders(customer){
  const my = orders.filter(o=>o.customer===customer.email);
  $('#customerOrdersTbl').innerHTML = my.length ? my.map(o=>{
    const actions = renderCustomerOrderActions(o);
    return `<div class="list-card order-card ${o.status==='pending_vendor'?'pending':o.status==='accepted'?'accepted':o.status==='rejected'?'rejected':'delivered'}"><div style="display:flex;align-items:center;gap:10px"><div style="flex:1"><div style="font-weight:700">${escapeHtml(o.product)}</div><div class="small">Vendor: ${escapeHtml(o.vendor)}</div><div class="small">${fmtNGN(o.price)} • ${o.status}</div></div><div style="display:flex;flex-direction:column;gap:6px"><div>${actions}</div><div><button class="btn ghost" onclick="openMapForCustomer('${o.id}')">Track</button></div></div></div></div>`;
  }).join('') : '<div class="small">No orders</div>';
}

function renderCustomerOrderActions(o){
  if(o.status==='pending_vendor') return `<button class="btn" onclick="cancelOrder('${o.id}')">Cancel (full refund)</button>`;
  if(o.status==='accepted') return `<button class="btn" onclick="cancelAcceptedOrderFlow('${o.id}')">Cancel (20% fee)</button> <button class="btn ghost" onclick="startSharingCustomer('${o.id}')">Share My Location</button>`;
  if(o.status==='delivered') return `<button class="btn" onclick="openRatingModal('${o.id}')">Leave Review</button>`;
  if(o.status==='rejected') return `<button class="btn" onclick="reorder('${o.id}')">Reorder</button>`;
  return '-';
}

function reorder(oldOrderId){
  const old = orders.find(o=>o.id===oldOrderId); if(!old) return alert('Not found'); const p = products.find(pp=>pp.id===old.productId); if(!p) return alert('Product removed'); initiatePurchase(p.id);
}

/* product modal (in-page) */
function openProductModal(pid){
  const p = products.find(x=>x.id===pid); if(!p) return alert('Product not found');
  const vendor = findUserByEmail(p.vendor); if(!vendor) return alert('Vendor missing');
  $('#productModal').style.display = 'flex';
  $('#pmVendorPhoto').innerHTML = vendor.profile.photo ? `<img src="${vendor.profile.photo}" style="width:100%;height:100%;object-fit:cover"/>` : `<div style="width:100%;height:100%;background:#eee"></div>`;
  $('#pmVendorName').textContent = vendor.name; $('#pmVendorBadge').innerHTML = vendor.badge ? '<span class="badge">Trusted</span>' : '';
  $('#pmVendorDesc').textContent = vendor.profile.desc || ''; $('#pmVendorRating').textContent = getVendorRating(vendor);
  $('#pmProductName').textContent = p.name; $('#pmProductImages').innerHTML = (p.images||[]).map(img=>`<img src="${img}" />`).join('') || '<div class="small">No images</div>';
  $('#pmProductPrice').textContent = fmtNGN(p.price); $('#pmProductVendorInfo').textContent = `${vendor.name} • ${vendor.email}`;
  const reviews = vendor.reviews || [];
  $('#pmReviews').innerHTML = reviews.length ? reviews.map(r=>`<div style="border-top:1px solid #eee;padding:6px"><strong>${escapeHtml(r.customer)}</strong> <span class="star">${'★'.repeat(r.stars)}</span><div>${escapeHtml(r.comment)}</div></div>`).join('') : '<div class="small">No reviews yet</div>';
  $('#pmBuyBtn').onclick = ()=>{ closeProductModal(); initiatePurchase(pid); };
}
function closeProductModal(){ $('#productModal').style.display = 'none'; }

/* purchase flows */
function initiatePurchaseFromList(productId){ initiatePurchase(productId); }
async function initiatePurchase(productId){
  const buyer = getUserById(session.userId); if(!buyer) return alert('Session lost');
  const p = products.find(x=>x.id===productId); if(!p) return alert('Product missing');
  if(buyer.balance < p.price) return alert('Insufficient funds');
  showConfirm(`Are you sure you want to purchase ${p.name} for ${fmtNGN(p.price)}?`, async ()=>{
    try{
      const pos = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
      const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude, ts:Date.now() };
      buyer.balance = Number((buyer.balance - p.price).toFixed(2));
      addTransaction(buyer.email,'debit', -p.price, `Purchase: ${p.name}`);
      const order = { id:rand('o'), product:p.name, productId:p.id, price:p.price, vendor:p.vendor, customer:buyer.email, status:'pending_vendor', customerLocation: loc, createdAt:new Date().toISOString(), customerLive:false, vendorLive:false, reviewed:false };
      orders.push(order); persist(); alert('Order placed. Vendor must accept.'); renderCustomer(buyer);
    }catch(err){
      buyer.balance = Number((buyer.balance - p.price).toFixed(2)); addTransaction(buyer.email,'debit', -p.price, `Purchase: ${p.name}`);
      const order = { id:rand('o'), product:p.name, productId:p.id, price:p.price, vendor:p.vendor, customer:buyer.email, status:'pending_vendor', customerLocation:null, createdAt:new Date().toISOString(), customerLive:false, vendorLive:false, reviewed:false };
      orders.push(order); persist(); renderCustomer(buyer); alert('Order placed (no location).');
    }
  });
}

/* cancel before acceptance */
function cancelOrder(orderId){
  const o = orders.find(x=>x.id===orderId); if(!o) return alert('Order missing'); if(o.status!=='pending_vendor') return alert('Cannot cancel at this stage here');
  const customer = findUserByEmail(o.customer);
  if(customer){ customer.balance = Number((customer.balance + o.price).toFixed(2)); addTransaction(customer.email,'credit', o.price, 'Refund: cancelled before acceptance'); }
  orders = orders.filter(x=>x.id!==orderId); persist();
  alert('Order cancelled and full refund issued');
  renderCustomer(getUserById(session.userId));
}

/* cancel after acceptance - 20% fee distribution */
function cancelAcceptedOrderFlow(orderId){
  const o = orders.find(x=>x.id===orderId); if(!o) return alert('Order missing'); if(o.status!=='accepted') return alert('Order not in accepted state');
  showConfirm(`This order has been accepted and is on the way. Cancelling this order will charge 20% of ${fmtNGN(o.price)} as a cancellation fee. Continue?`, ()=>{
    showConfirm('Are you sure you want to cancel this order?', ()=>{
      const fee = Number((o.price * 0.20).toFixed(2));
      const refund = Number((o.price - fee).toFixed(2));
      const vendorShare = Number((fee * 0.75).toFixed(2));
      const adminShare = Number((fee * 0.25).toFixed(2));
      const vendor = findUserByEmail(o.vendor);
      const admin = users.find(u=>u.role==='admin');
      const customer = findUserByEmail(o.customer);
      if(customer){ customer.balance = Number((customer.balance + refund).toFixed(2)); addTransaction(customer.email,'credit', refund, 'Partial refund after cancellation'); }
      if(vendor){
        const creditedAtAccept = Number((o.price * 0.95).toFixed(2));
        const deduction = Number((creditedAtAccept - vendorShare).toFixed(2));
        vendor.balance = Number((vendor.balance - deduction).toFixed(2));
        addTransaction(vendor.email,'debit', -deduction, 'Adjustment due to customer cancellation');
        addTransaction(vendor.email,'credit', vendorShare, 'Vendor share of cancellation fee');
      }
      if(admin){ admin.balance = Number((admin.balance + adminShare).toFixed(2)); addTransaction(admin.email,'credit', adminShare, 'Admin share of cancellation fee'); }
      o.status = 'cancelled'; o.cancelledAt = new Date().toISOString(); o.cancellation = { fee, refund, vendorShare, adminShare }; persist();
      alert(`Your order has been cancelled. You were charged ${fmtNGN(fee)} (20%).`);
      renderCustomer(getUserById(session.userId));
      if(vendor) renderVendor(vendor);
      renderAdmin(users.find(u=>u.role==='admin'));
    });
  });
}

/* leave review (customer) */
function openRatingModal(orderId){
  const o = orders.find(x=>x.id===orderId); if(!o) return alert('Order not found');
  if(o.reviewed) return alert('You already reviewed this order');
  const vendor = findUserByEmail(o.vendor); if(!vendor) return alert('Vendor missing');
  $('#ratingVendorInfo').textContent = `${vendor.name} — ${o.product}`; $('#ratingStars').value = 5; $('#ratingComment').value = '';
  $('#ratingModal').style.display = 'flex';
  $('#ratingSubmit').onclick = ()=>{ const stars = Number($('#ratingStars').value) || 5; const comment = $('#ratingComment').value || ''; vendor.reviews = vendor.reviews || []; vendor.reviews.push({ orderId: o.id, customer: getUserById(session.userId).name, stars: Math.round(stars), comment, ts: Date.now() }); o.reviewed = true; persist(); $('#ratingModal').style.display = 'none'; alert('Thanks for your review'); renderCustomer(getUserById(session.userId)); };
}
function closeRatingModal(){ $('#ratingModal').style.display = 'none'; }

/* admin approve/reject order override */
function adminApprove(orderId){
  const order = orders.find(o=>o.id===orderId); if(!order) return alert('Not found');
  if(order.status==='accepted') return alert('Already accepted');
  const vendor = findUserByEmail(order.vendor);
  if(vendor){ const vendorAmt = Number((order.price * 0.95).toFixed(2)); vendor.balance = Number((vendor.balance + vendorAmt).toFixed(2)); addTransaction(vendor.email,'credit', vendorAmt, `Sale (95%) - ${order.product}`); }
  const admin = users.find(u=>u.role==='admin'); if(admin){ const adminAmt = Number((order.price * 0.05).toFixed(2)); admin.balance = Number((admin.balance + adminAmt).toFixed(2)); addTransaction(admin.email,'credit', adminAmt, `Commission (5%) - ${order.product}`); }
  order.status = 'accepted'; order.adminApprovedAt = new Date().toISOString(); persist();
  try{ startVendorLive(orderId); }catch(e){}
  alert('Admin approved and vendor credited (95%). Admin got 5% commission.');
  renderAdmin(users.find(u=>u.role==='admin'));
}
function adminReject(orderId){
  const order = orders.find(o=>o.id===orderId); if(!order) return alert('Not found');
  if(order.status==='rejected') return alert('Already rejected');
  const customer = findUserByEmail(order.customer);
  if(customer){ customer.balance = Number((customer.balance + order.price).toFixed(2)); addTransaction(customer.email,'credit', order.price, 'Admin rejected refund'); }
  order.status = 'rejected'; order.adminRejectedAt = new Date().toISOString(); persist();
  alert('Admin rejected and customer refunded');
  renderAdmin(users.find(u=>u.role==='admin'));
}

/* ==================== Live Tracking helpers ==================== */
function startVendorLive(orderId){
  if(liveWatchers.vendor[orderId]) return;
  if(!navigator.geolocation) return;
  const watchId = navigator.geolocation.watchPosition(pos=>{
    const o = orders.find(x=>x.id===orderId); if(!o) return;
    o.vendorLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude, ts: Date.now() };
    o.vendorLive = true; persist();
    if(currentMapOrder && currentMapOrder.id===orderId) updateMapForOrder(currentMapOrder);
  }, err=>console.warn('watch error',err), { enableHighAccuracy:true, maximumAge:5000, timeout:10000 });
  liveWatchers.vendor[orderId] = watchId;
}
function stopVendorLive(orderId){
  const id = liveWatchers.vendor[orderId];
  if(id!=null){ navigator.geolocation.clearWatch(id); delete liveWatchers.vendor[orderId]; const o = orders.find(x=>x.id===orderId); if(o){ o.vendorLive=false; persist(); } }
}
function startCustomerLive(orderId){
  if(liveWatchers.customer[orderId]) return;
  if(!navigator.geolocation) return alert('Geolocation not supported');
  const watchId = navigator.geolocation.watchPosition(pos=>{
    const o = orders.find(x=>x.id===orderId); if(!o) return;
    o.customerLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude, ts: Date.now() };
    o.customerLive = true; persist();
    if(currentMapOrder && currentMapOrder.id===orderId) updateMapForOrder(currentMapOrder);
  }, err=>console.warn('watch err',err), { enableHighAccuracy:true, maximumAge:5000, timeout:10000 });
  liveWatchers.customer[orderId] = watchId;
  alert('Started sharing your live location for this order');
  renderCustomer(getUserById(session.userId));
}
function stopCustomerLive(orderId){
  const id = liveWatchers.customer[orderId];
  if(id!=null){ navigator.geolocation.clearWatch(id); delete liveWatchers.customer[orderId]; const o = orders.find(x=>x.id===orderId); if(o){ o.customerLive=false; persist(); } alert('Stopped sharing live location'); renderCustomer(getUserById(session.userId)); }
}
function stopAllLiveWatchersForUser(user){
  orders.forEach(o=>{
    if(o.vendor===user.email && liveWatchers.vendor[o.id]){ navigator.geolocation.clearWatch(liveWatchers.vendor[o.id]); delete liveWatchers.vendor[o.id]; }
    if(o.customer===user.email && liveWatchers.customer[o.id]){ navigator.geolocation.clearWatch(liveWatchers.customer[o.id]); delete liveWatchers.customer[o.id]; }
  });
}
function restoreLiveWatchers(){
  if(!session) return;
  const user = getUserById(session.userId);
  if(!user) return;
  if(user.role==='vendor'){
    orders.filter(o=>o.vendor===user.email && o.status==='accepted').forEach(o=>startVendorLive(o.id));
  }
  if(user.role==='customer'){
    orders.filter(o=>o.customer===user.email && (o.status==='pending_vendor' || o.status==='accepted')).forEach(o=>{ if(o.customerLive) startCustomerLive(o.id); });
  }
}

/* ==================== Map UI ==================== */
let map, vendorMarker, customerMarker, currentMapOrder = null, mapAutoTimer = null;
function ensureMapInitialized(){
  if(map) return;
  map = L.map('map').setView([9.0820,8.6753],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);
  vendorMarker = L.marker([0,0], { icon: L.divIcon({ className:'vendor-icon', html:'<div style="font-size:26px">🚚</div>', iconSize:[26,26], iconAnchor:[13,13] }) }).addTo(map).bindPopup('Vendor');
  customerMarker = L.marker([0,0], { icon: L.divIcon({ className:'customer-icon', html:'<div style="font-size:24px">👤</div>', iconSize:[24,24], iconAnchor:[12,12] }) }).addTo(map).bindPopup('Customer');
}
function updateMapForOrder(order){
  if(!map) return;
  const v = order.vendorLocation, c = order.customerLocation;
  const pts = [];
  if(v){ vendorMarker.setLatLng([v.lat,v.lng]).bindPopup(`Vendor<br/>${new Date(v.ts).toLocaleString()}`); pts.push([v.lat,v.lng]); }
  if(c){ customerMarker.setLatLng([c.lat,c.lng]).bindPopup(`Customer<br/>${new Date(c.ts).toLocaleString()}`); pts.push([c.lat,c.lng]); }
  if(pts.length) map.fitBounds(pts,{ maxZoom:15, padding:[50,50] });
}
function openMapForVendor(orderId){
  const o = orders.find(x=>x.id===orderId); if(!o) return alert('Order not found');
  currentMapOrder = o; $('#mapTitle').textContent = `Order ${o.id} — Vendor view`; $('#mapModal').style.display = 'flex'; ensureMapInitialized(); updateMapForOrder(o);
  $('#mapRefresh').onclick = ()=>updateMapForOrder(o);
  $('#mapStop').onclick = ()=>{ stopVendorLive(o.id); alert('Stopped vendor live'); };
  $('#mapClose').onclick = ()=>{ $('#mapModal').style.display = 'none'; if(mapAutoTimer){ clearInterval(mapAutoTimer); mapAutoTimer = null; } };
  // start auto-refresh every 5s
  if(mapAutoTimer) clearInterval(mapAutoTimer);
  mapAutoTimer = setInterval(()=>updateMapForOrder(o), 5000);
}
function openMapForCustomer(orderId){
  const o = orders.find(x=>x.id===orderId); if(!o) return alert('Order not found');
  currentMapOrder = o; $('#mapTitle').textContent = `Order ${o.id} — Customer view`; $('#mapModal').style.display = 'flex'; ensureMapInitialized(); updateMapForOrder(o);
  $('#mapRefresh').onclick = ()=>updateMapForOrder(o);
  $('#mapStop').onclick = ()=>{ stopCustomerLive(o.id); alert('Stopped sharing your live location'); };
  $('#mapClose').onclick = ()=>{ $('#mapModal').style.display = 'none'; if(mapAutoTimer){ clearInterval(mapAutoTimer); mapAutoTimer = null; } };
  if(mapAutoTimer) clearInterval(mapAutoTimer);
  mapAutoTimer = setInterval(()=>updateMapForOrder(o), 5000);
}
function openMapForAdmin(orderId){
  const o = orders.find(x=>x.id===orderId); if(!o) return alert('Order not found');
  currentMapOrder = o; $('#mapTitle').textContent = `Order ${o.id} — Admin view`; $('#mapModal').style.display = 'flex'; ensureMapInitialized(); updateMapForOrder(o);
  $('#mapRefresh').onclick = ()=>updateMapForOrder(o);
  $('#mapStop').onclick = ()=>{ stopVendorLive(o.id); stopCustomerLive(o.id); alert('Stopped live tracking for this order (admin)'); };
  $('#mapClose').onclick = ()=>{ $('#mapModal').style.display = 'none'; if(mapAutoTimer){ clearInterval(mapAutoTimer); mapAutoTimer = null; } };
  if(mapAutoTimer) clearInterval(mapAutoTimer);
  mapAutoTimer = setInterval(()=>updateMapForOrder(o), 5000);
}

/* ==================== Transactions & Payment modal ==================== */
function openPayModal(mode){
  $('#payTitle').textContent = mode === 'topup' ? 'Top-up Wallet' : 'Withdraw from Wallet';
  $('#payDesc').textContent = mode === 'topup' ? 'Simulated top-up via card (dummy).' : 'Simulated withdrawal request (dummy).';
  $('#payForm').onsubmit = (e)=>handlePaySubmit(e, mode);
  $('#payModal').style.display = 'flex';
}
function closePayModal(){ $('#payModal').style.display = 'none'; $('#payForm').onsubmit = null; $('#payForm').reset(); }
function handlePaySubmit(e, mode){
  e.preventDefault();
  const amount = Number($('#payAmount').value) || 0;
  if(amount <= 0) return alert('Enter a positive amount');
  const me = getUserById(session.userId);
  if(mode === 'topup'){
    me.balance = Number((me.balance + amount).toFixed(2)); addTransaction(me.email,'credit', amount, 'Top-up (card)'); persist(); alert(`Top-up successful: ${fmtNGN(amount)}`); closePayModal(); renderApp();
  } else {
    if(me.balance < amount) return alert('Insufficient funds');
    me.balance = Number((me.balance - amount).toFixed(2)); addTransaction(me.email,'debit', -amount, 'Withdrawal (simulated)'); persist(); alert(`Withdrawal processed (simulated): ${fmtNGN(amount)}`); closePayModal(); renderApp();
  }
}

/* transactions modal using product modal view */
function showTransactionsModal(email){
  const u = findUserByEmail(email); if(!u) return alert('User not found');
  $('#pmVendorPhoto').innerHTML = u.profile.photo ? `<img src="${u.profile.photo}" style="width:100%;height:100%;object-fit:cover"/>` : `<div style="width:100%;height:100%;background:#eee"></div>`;
  $('#pmVendorName').textContent = u.name + ` (${u.role})`; $('#pmVendorBadge').innerHTML = u.badge ? '<span class="badge">Trusted</span>' : '';
  $('#pmVendorDesc').textContent = `Transaction history for ${u.name}`; $('#pmVendorRating').textContent = '';
  $('#pmProductName').textContent = 'Transactions'; $('#pmProductImages').innerHTML = '';
  $('#pmProductPrice').textContent = ''; $('#pmProductVendorInfo').textContent = '';
  $('#pmReviews').innerHTML = (u.transactions||[]).map(t=>`<div style="border-top:1px solid #eee;padding:6px"><div style="font-weight:700">${t.type.toUpperCase()}</div><div class="small">${new Date(t.ts).toLocaleString()}</div><div class="${t.amount<0?'tx-debit':'tx-credit'}">${fmtNGN(t.amount)}</div><div class="small">${escapeHtml(t.note||'')}</div></div>`).join('') || '<div class="small">No transactions</div>';
  $('#pmBuyBtn').style.display = 'none';
  $('#productModal').style.display = 'flex';
}

/* ==================== Utility functions ==================== */
function getCurrentPosition(options){ return new Promise((res, rej)=>{ if(!navigator.geolocation) return rej(new Error('Geolocation not supported')); navigator.geolocation.getCurrentPosition(res, rej, options||{ enableHighAccuracy:true, timeout:10000 }); }); }
function fileToBase64(file){ return new Promise((res, rej)=>{ const fr = new FileReader(); fr.onload = e=>res(e.target.result); fr.onerror = rej; fr.readAsDataURL(file); }); }
function showConfirm(text, onYes){ $('#confirmText').textContent = text; $('#confirmModal').style.display = 'flex'; const yes = $('#confirmYes'), no = $('#confirmNo'); yes.onclick = ()=>{ $('#confirmModal').style.display = 'none'; onYes && onYes(); }; no.onclick = ()=>{ $('#confirmModal').style.display = 'none'; }; }
function getVendorRating(vendor){ const r = vendor.reviews||[]; if(!r.length) return '0.0'; const avg = r.reduce((s,x)=>s+x.stars,0)/r.length; return Number(avg.toFixed(1)); }

/* ==================== Product modal quick open (used in admin/vendor/customer) ==================== */
function openProductModalById(pid){ openProductModal(pid); }

/* ==================== Misc helpers ==================== */
window._LB = { users, products, orders, badgeRequests, persist };

/* ==================== Initial render ==================== */
renderAuth();

/* ensure mobile nav */
window.addEventListener('resize', ()=>{ document.getElementById('mobileNav').style.display = window.innerWidth <= 720 ? 'flex' : 'none'; });

/* -------------- Public functions used by inline handlers -------------- */
window.adminSelectSuggestion = window.adminSelectSuggestion || function(uid){ /* defined earlier by renderAdmin */ };
window.openProfileModal = openProfileModal;
window.closeProfileModal = closeProfileModal;
window.openPayModal = openPayModal;
window.closePayModal = closePayModal;
window.openProductModal = openProductModal;
window.openProductModalById = openProductModalById;
window.closeProductModal = closeProductModal;
window.openMapForVendor = openMapForVendor;
window.openMapForCustomer = openMapForCustomer;
window.openMapForAdmin = openMapForAdmin;
window.startSharingCustomer = startCustomerLive;
window.showTransactionsModal = showTransactionsModal;
window.openPayModal = openPayModal;
window.cancelOrder = cancelOrder;
window.cancelAcceptedOrderFlow = cancelAcceptedOrderFlow;
window.openRatingModal = openRatingModal;

/* Expose simple actions for small demos */
window.renderAdmin = renderAdmin;
window.renderVendor = renderVendor;
window.renderCustomer = renderCustomer;

/* If the user reloaded and session exists, restore session view */
(function restoreSession(){
  // no persistent session stored; session variable is in-memory only.
  // If you want persistent session across reloads, store session.userId in localStorage and restore here.
})();

</script>
</body>
</html>
