<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LocalBank Marketplace — Live Tracking (Fixed)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root{--bg:#f4f7fb;--card:#fff;--accent:#0b67d0;--muted:#667085;--success:#16a34a;--danger:#e11d48;font-family:Inter,system-ui,Arial,sans-serif}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#0b1220}
    .wrap{max-width:1100px;margin:26px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(11,22,40,0.06)}
    header h1{margin:0;font-size:18px}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(11,22,40,0.04);}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:14px}
    .hidden{display:none}
    form input, form select, form button, .field{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #e6eef8}
    .btn{background:var(--accent);color:white;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,103,208,0.12)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #eef3fb;text-align:left;font-size:13px}
    img.thumb{width:64px;height:64px;object-fit:cover;border-radius:6px}
    .small{font-size:13px;color:var(--muted)}
    .carousel{display:flex;gap:6px;align-items:center}
    .carousel img{width:120px;height:90px;object-fit:cover;border-radius:6px}
    .actions button{margin-right:6px}
    #mapModal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:999;align-items:center;justify-content:center}
    #mapFrame{width:90%;max-width:900px;height:75%;background:white;border-radius:8px;padding:10px;display:flex;flex-direction:column}
    #map{flex:1;border-radius:6px}
    .tiny{font-size:12px;color:var(--muted)}
    @media (max-width:980px){.grid{grid-template-columns:1fr} header{flex-direction:column;gap:8px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>LocalBank Marketplace — Live Tracking (Fixed)</h1>
      <div id="sessionBox" class="small">Not signed in</div>
    </header>

    <div id="root"></div>

    <footer style="margin-top:16px;color:var(--muted);font-size:13px">Data in localStorage: <code>lb_users</code>, <code>lb_products</code>, <code>lb_orders</code>. Live tracking uses browser Geolocation (watchPosition).</footer>
  </div>

  <!-- Map Modal -->
  <div id="mapModal">
    <div id="mapFrame">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <strong id="mapTitle">Tracking</strong>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="mapRefresh" class="btn">Refresh</button>
          <button id="mapStop" class="btn ghost">Stop Live</button>
          <button id="mapClose" class="btn ghost">Close</button>
        </div>
      </div>
      <div id="map"></div>
      <div class="tiny" style="margin-top:8px">Markers update live while the user has allowed location sharing in this browser session.</div>
    </div>
  </div>

  <!-- Confirm modal reused (kept near map so handlers can find it) -->
  <div id="confirmModal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:900">
    <div class="card" style="width:360px;text-align:center">
      <p style="margin:0 0 12px">Are you sure you want to continue this process?</p>
      <div style="display:flex;gap:8px;justify-content:center">
        <button id="confirmYes" class="btn">Continue</button>
        <button id="confirmNo" class="btn ghost">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
  // STORAGE KEYS
  const K_USERS='lb_users', K_PRODUCTS='lb_products', K_ORDERS='lb_orders';

  // helpers
  const $ = s=>document.querySelector(s);
  const rand = p=> (p||'id')+'_'+Math.random().toString(36).slice(2,9);
  const fmt = n => Number(n).toFixed(2);

  // load or seed
  let users = JSON.parse(localStorage.getItem(K_USERS) || 'null') || [ {id:'admin1',name:'Admin',email:'admin@localbank',password:'admin123',role:'admin',balance:0} ];
  let products = JSON.parse(localStorage.getItem(K_PRODUCTS) || 'null') || [];
  let orders = JSON.parse(localStorage.getItem(K_ORDERS) || 'null') || [];
  let session = null; // {userId}

  // in-memory live watch storage (not persisted across reloads)
  const liveWatchers = { vendor: {}, customer: {} }; // e.g. liveWatchers.vendor[orderId] = watchId

  function persist(){ localStorage.setItem(K_USERS, JSON.stringify(users)); localStorage.setItem(K_PRODUCTS, JSON.stringify(products)); localStorage.setItem(K_ORDERS, JSON.stringify(orders)); }

  // AUTH UI
  function renderAuth(){
    $('#sessionBox').textContent='Not signed in';
    const html = `
      <div class="grid">
        <div>
          <div class="card">
            <h3>Register</h3>
            <form id="regForm">
              <input id="regName" placeholder="Full name" required />
              <input id="regEmail" type="email" placeholder="Email" required />
              <input id="regPass" type="password" placeholder="Password" required />
              <select id="regRole"><option value="customer">Customer</option><option value="vendor">Vendor</option></select>
              <div style="display:flex;gap:8px;margin-top:10px"><button class="btn">Register</button><button id="regReset" type="button" class="btn ghost">Reset</button></div>
            </form>
          </div>
          <div class="card" style="margin-top:12px">
            <h3>Login (Vendor/Customer)</h3>
            <form id="loginForm">
              <input id="logEmail" type="email" placeholder="Email" required />
              <input id="logPass" type="password" placeholder="Password" required />
              <div style="display:flex;gap:8px;margin-top:10px"><button class="btn">Login</button><button id="guestBtn" type="button" class="btn ghost">Guest (customer)</button></div>
            </form>
          </div>
        </div>
        <div>
          <div class="card">
            <h3>Admin Login</h3>
            <form id="adminForm">
              <input id="adminEmail" type="email" placeholder="Admin email" required />
              <input id="adminPass" type="password" placeholder="Password" required />
              <div style="display:flex;gap:8px;margin-top:10px"><button class="btn">Admin Login</button><button id="showData" type="button" class="btn ghost">Show Raw Data</button></div>
            </form>
          </div>
        </div>
      </div>
    `;

    $('#root').innerHTML = html;

    // Register
    $('#regForm').onsubmit = e=>{
      e.preventDefault();
      const name = $('#regName').value.trim();
      const email = $('#regEmail').value.trim().toLowerCase();
      const pass = $('#regPass').value;
      const role = $('#regRole').value;
      if(users.find(u=>u.email===email)) return alert('Email exists');
      users.push({id:rand('u'),name,email,password:pass,role,balance:0});
      persist();
      alert('Registered. Please login.');
      $('#regForm').reset();
    };
    $('#regReset').onclick = ()=>$('#regForm').reset();

    // Login (vendor/customer)
    $('#loginForm').onsubmit = e=>{
      e.preventDefault();
      const email = $('#logEmail').value.trim().toLowerCase();
      const pass = $('#logPass').value;
      const u = users.find(x=>x.email===email && x.password===pass && x.role!=='admin');
      if(!u) return alert('Invalid');
      session = {userId:u.id};
      restoreLiveWatchers();
      renderApp();
    };

    $('#guestBtn').onclick = ()=>{
      let g = users.find(u=>u.role==='customer');
      if(!g){ g={id:rand('u'),name:'Guest',email:'guest@localbank',password:'guest',role:'customer',balance:50}; users.push(g); persist(); }
      session = {userId:g.id};
      restoreLiveWatchers();
      renderApp();
    };

    // Admin login
    $('#adminForm').onsubmit = e=>{
      e.preventDefault();
      const email = $('#adminEmail').value.trim().toLowerCase();
      const pass = $('#adminPass').value;
      const u = users.find(x=>x.email===email && x.password===pass && x.role==='admin');
      if(!u) return alert('Invalid admin');
      session = {userId:u.id};
      restoreLiveWatchers();
      renderApp();
    };

    $('#showData').onclick = ()=>{ console.log({users,products,orders}); alert('Check console for raw data'); };
  }

  // APP
  function renderApp(){
    const u = users.find(x=>x.id===session.userId);
    $('#sessionBox').textContent = `${u.name} — ${u.role} | Sign out`;
    $('#sessionBox').onclick = ()=>{ if(confirm('Sign out?')){ stopAllLiveWatchersForUser(u); session=null; renderAuth(); } };
    if(u.role==='admin') renderAdmin(u);
    if(u.role==='vendor') renderVendor(u);
    if(u.role==='customer') renderCustomer(u);
  }

  // ADMIN
  function renderAdmin(admin){
    const html = `
      <div class="grid">
        <div>
          <div class="card"><h3>Users</h3><div class="small">Total users: ${users.length}</div><table id="adminUsers"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Balance</th></tr></thead><tbody></tbody></table></div>
          <div class="card" style="margin-top:12px"><h3>Products</h3><table id="adminProducts"><thead><tr><th>Image</th><th>Product</th><th>Price</th><th>Vendor</th></tr></thead><tbody></tbody></table></div>
          <div class="card" style="margin-top:12px"><h3>Orders</h3><table id="adminOrders"><thead><tr><th>ID</th><th>Product</th><th>Customer</th><th>Vendor</th><th>Price</th><th>Status</th><th>Action</th><th>Track</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div>
          <div class="card"><h3>Account Adjust</h3><form id="adminAdj"><input id="adjEmail" placeholder="User email" /><input id="adjAmt" type="number" placeholder="Amount (+ credit, - debit)" /><div style="display:flex;gap:8px;margin-top:8px"><button class="btn">Apply</button><button id="adminRefresh" type="button" class="btn ghost">Refresh</button></div></form></div>
          <div class="card" style="margin-top:12px"><h3>Quick</h3><div style="display:flex;flex-direction:column;gap:8px"><button id="dumpData" class="btn ghost">Export Data (console)</button><button id="resetAll" class="btn ghost">Reset Demo</button></div></div>
        </div>
      </div>
    `;
    $('#root').innerHTML = html;
    $('#adminUsers tbody').innerHTML = users.map(u=>`<tr><td>${u.name}</td><td>${u.email}</td><td>${u.role}</td><td>$${fmt(u.balance)}</td></tr>`).join('');
    $('#adminProducts tbody').innerHTML = products.map(p=>`<tr><td><img class="thumb" src="${(p.images&&p.images[0])||''}"/></td><td>${p.name}</td><td>$${fmt(p.price)}</td><td>${p.vendor}</td></tr>`).join('')||'<tr><td colspan="4">No products</td></tr>';
    renderAdminOrders();

    $('#adminAdj').onsubmit = e=>{ e.preventDefault(); const email=$('#adjEmail').value.trim().toLowerCase(); const amt=parseFloat($('#adjAmt').value)||0; const uu=users.find(x=>x.email===email); if(!uu) return alert('User not found'); uu.balance+=amt; persist(); alert('Updated'); renderAdmin(admin); };
    $('#dumpData').onclick = ()=>{ console.log({users,products,orders}); alert('See console'); };
    $('#resetAll').onclick = ()=>{ if(!confirm('Reset demo?')) return; localStorage.removeItem(K_USERS); localStorage.removeItem(K_PRODUCTS); localStorage.removeItem(K_ORDERS); location.reload(); };
    $('#adminRefresh').onclick = ()=>renderAdmin(admin);
  }

  function renderAdminOrders(){
    const tbody = $('#adminOrders tbody');
    tbody.innerHTML = orders.map(o=>`<tr><td>${o.id}</td><td>${o.product}</td><td>${o.customer}</td><td>${o.vendor}</td><td>$${fmt(o.price)}</td><td>${o.status}</td><td>${o.status.startsWith('pending')?`<button class='btn' onclick="adminApprove('${o.id}')">Approve</button><button class='btn ghost' onclick="adminReject('${o.id}')">Reject</button>`:'-'}</td><td><button class='btn ghost' onclick="openMapForAdmin('${o.id}')">Track</button></td></tr>`).join('')||'<tr><td colspan="8">No orders</td></tr>';
  }

  // VENDOR
  function renderVendor(vendor){
    const html = `
      <div class="grid">
        <div>
          <div class="card"><h3>Vendor</h3><div class="small">${vendor.name} — Balance $${fmt(vendor.balance)}</div></div>
          <div class="card" style="margin-top:12px"><h3>Add Product (photos)</h3><form id="prodForm"><input id="pName" placeholder="Product" required /><input id="pPrice" type="number" placeholder="Price" required /><input id="pImages" type="file" accept="image/*" multiple /><div style="display:flex;gap:8px;margin-top:8px"><button class="btn">Add</button><button id="clearUpload" type="button" class="btn ghost">Clear</button></div></form></div>
          <div class="card" style="margin-top:12px"><h3>Your Products</h3><table id="vendorProductsTbl"><thead><tr><th>Image</th><th>Name</th><th>Price</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div>
          <div class="card"><h3>Orders (pending vendor)</h3><table id="vendorOrdersTbl"><thead><tr><th>Product</th><th>Customer</th><th>Price</th><th>Action</th><th>Track</th></tr></thead><tbody></tbody></table></div>
          <div class="card" style="margin-top:12px"><h3>Live Tracking</h3><div class="small">When you accept an order, live tracking starts (prompts for permission). You can stop live updates anytime.</div></div>
        </div>
      </div>
    `;
    $('#root').innerHTML = html;

    $('#prodForm').onsubmit = async e=>{
      e.preventDefault();
      const name = $('#pName').value.trim();
      const price = parseFloat($('#pPrice').value)||0;
      const files = $('#pImages').files;
      if(!name||!price) return alert('Name and price required');
      const imgs = [];
      for(let i=0;i<files.length;i++){ imgs.push(await fileToBase64(files[i])); }
      products.push({id:rand('p'),name,price,images:imgs,vendor:vendor.email});
      persist();
      alert('Added');
      renderVendor(vendor);
    };

    $('#clearUpload').onclick = ()=>{ $('#pImages').value=''; $('#pName').value=''; $('#pPrice').value=''; };
    renderVendorProducts(vendor);
    renderVendorOrders(vendor);
  }

  function renderVendorProducts(vendor){
    const tbody=$('#vendorProductsTbl tbody');
    const my=products.filter(p=>p.vendor===vendor.email);
    tbody.innerHTML = my.map(p=>`<tr><td><img class='thumb' src='${p.images[0]||''}'/></td><td>${p.name}</td><td>$${fmt(p.price)}</td><td><button class='btn ghost' onclick="viewProduct('${p.id}')">View</button></td></tr>`).join('')||'<tr><td colspan="4">No products</td></tr>';
  }

  function renderVendorOrders(vendor){
    const tbody=$('#vendorOrdersTbl tbody');
    const my=orders.filter(o=>o.vendor===vendor.email && o.status==='pending_vendor');
    tbody.innerHTML = my.map(o=>`<tr><td>${o.product}</td><td>${o.customer}</td><td>$${fmt(o.price)}</td><td><button class='btn' onclick="vendorAccept('${o.id}')">Accept</button><button class='btn ghost' onclick="vendorReject('${o.id}')">Reject</button></td><td><button class='btn ghost' onclick="openMapForVendor('${o.id}')">View</button></td></tr>`).join('')||'<tr><td colspan="5">No pending orders</td></tr>';
  }

  // CUSTOMER
  function renderCustomer(customer){
    const html = `
      <div class="grid">
        <div>
          <div class="card"><h3>Customer</h3><div class="small">${customer.name} — Balance $${fmt(customer.balance)}</div></div>
          <div class="card" style="margin-top:12px"><h3>Available Products</h3><table id="customerProducts"><thead><tr><th>Images</th><th>Product</th><th>Price</th><th>Vendor</th><th>Action</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div>
          <div class="card"><h3>Your Orders</h3><table id="customerOrdersTbl"><thead><tr><th>ID</th><th>Product</th><th>Vendor</th><th>Price</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div>
          <div class="card" style="margin-top:12px"><h3>Live Tracking</h3><div class="small">When vendor accepts, live vendor location will be shown. You can also start/stop sharing your live location for an order.</div></div>
        </div>
      </div>
    `;
    $('#root').innerHTML = html;
    renderCustomerProducts(customer);
    renderCustomerOrders(customer);
  }

  function renderCustomerProducts(customer){
    const tbody=$('#customerProducts tbody');
    tbody.innerHTML = products.map(p=>{
      const imgs=p.images||[];
      return `<tr><td><img class='thumb' src='${imgs[0]||''}'/></td><td>${p.name}</td><td>$${fmt(p.price)}</td><td>${p.vendor}</td><td><button class='btn' onclick="initiatePurchase('${p.id}')">Buy</button> <button class='btn ghost' onclick="viewProduct('${p.id}')">View</button></td></tr>`;
    }).join('')||'<tr><td colspan="5">No products</td></tr>';
  }

  function renderCustomerOrders(customer){
    const tbody=$('#customerOrdersTbl tbody');
    const my=orders.filter(o=>o.customer===customer.email);
    tbody.innerHTML = my.map(o=>`<tr><td>${o.id}</td><td>${o.product}</td><td>${o.vendor}</td><td>$${fmt(o.price)}</td><td>${o.status}</td><td>${o.status==='accepted'?`<button class='btn ghost' onclick="openMapForCustomer('${o.id}')">Track Vendor</button>`: (o.status==='pending_vendor'?`<button class='btn' onclick="startCustomerLive('${o.id}')">Share Live</button> <button class='btn ghost' onclick="stopCustomerLive('${o.id}')">Stop Sharing</button>`:'-')}</td></tr>`).join('')||'<tr><td colspan="6">No orders</td></tr>';
  }

  // product view — open a proper HTML document in a new window (fix for document.write error)
  window.viewProduct = function(pid){
    const p = products.find(x=>x.id===pid);
    if(!p) return alert('Not found');
    const thumbs = (p.images||[]).map(img=>`<img style="width:120px;height:90px;object-fit:cover;margin:6px;border-radius:6px" src="${img}"/>`).join('');
    const bodyHtml = `<div style="font-family:Arial;padding:8px"> <h3>${escapeHtml(p.name)}</h3><div>$${fmt(p.price)}</div><div>By: ${escapeHtml(p.vendor)}</div><div style="margin-top:8px">${thumbs}</div></div>`;
    const full = `<!doctype html><html><head><meta charset="utf-8"><title>${escapeHtml(p.name)}</title><style>body{font-family:Arial;margin:10px}</style></head><body>${bodyHtml}</body></html>`;
    const w = window.open('','_blank','width=520,height=420');
    if(!w) return alert('Popup blocked. Please allow popups for this site to view product details.');
    try{
      w.document.open();
      w.document.write(full);
      w.document.close();
    }catch(err){
      console.error('Failed to open product window',err);
      alert('Unable to open product window');
    }
  };

  // PURCHASE flow with live tracking capability
  window.initiatePurchase = function(productId){
    const buyer = users.find(u=>u.id===session.userId);
    if(!buyer) return alert('Session lost');
    const p = products.find(x=>x.id===productId);
    if(!p) return alert('Product missing');
    if(buyer.balance < p.price) return alert('Insufficient funds');

    // show confirm modal
    const confirmModal = $('#confirmModal');
    confirmModal.style.display = 'flex';

    const yesBtn = $('#confirmYes');
    const noBtn = $('#confirmNo');

    // remove previous handlers
    yesBtn.onclick = null;
    noBtn.onclick = null;

    yesBtn.onclick = async ()=>{
      // attempt to capture a one-time location snapshot for the customer
      try{
        const loc = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
        const customerLoc = {lat:loc.coords.latitude,lng:loc.coords.longitude,ts:Date.now()};
        buyer.balance -= p.price;
        const order = {id:rand('o'),product:p.name,productId:p.id,price:p.price,vendor:p.vendor,customer:buyer.email,status:'pending_vendor',customerLocation:customerLoc,createdAt:new Date().toISOString(),customerLive:false,vendorLive:false};
        orders.push(order);
        persist();
        alert('Order placed. Vendor must accept.');
        renderCustomer(buyer);
      }catch(err){
        // place order without location snapshot
        buyer.balance -= p.price;
        const order = {id:rand('o'),product:p.name,productId:p.id,price:p.price,vendor:p.vendor,customer:buyer.email,status:'pending_vendor',customerLocation:null,createdAt:new Date().toISOString(),customerLive:false,vendorLive:false};
        orders.push(order);
        persist();
        renderCustomer(buyer);
        alert('Order placed (no location).');
      }
      confirmModal.style.display = 'none';
    };

    noBtn.onclick = ()=>{ confirmModal.style.display = 'none'; };
  };

  // Vendor accept — starts vendor live watch (watchPosition)
  window.vendorAccept = async function(orderId){
    const order = orders.find(o=>o.id===orderId);
    if(!order) return alert('Order not found');
    const vendorUser = users.find(u=>u.email===order.vendor);
    try{
      const loc = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
      order.vendorLocation = {lat:loc.coords.latitude,lng:loc.coords.longitude,ts:Date.now()};
      order.status = 'accepted';
      persist();

      // credit vendor
      vendorUser.balance += order.price;
      persist();

      // start live watch for vendor
      startVendorLive(orderId);

      alert('Order accepted and vendor credited. Live tracking started.');
      renderVendor(vendorUser);
    }catch(err){
      alert('Could not get vendor location. Accept aborted.');
    }
  };

  window.vendorReject = function(orderId){
    const order = orders.find(o=>o.id===orderId);
    if(!order) return alert('Order not found');
    const customer = users.find(u=>u.email===order.customer);
    if(customer){ customer.balance += order.price; }
    order.status = 'rejected';
    persist();
    alert('Order rejected and customer refunded');
    const vendorUser = users.find(u=>u.email===order.vendor);
    renderVendor(vendorUser);
  };

  // ADMIN approve/reject (override)
  window.adminApprove = function(orderId){
    const order = orders.find(o=>o.id===orderId);
    if(!order) return alert('Order not found');
    if(order.status==='accepted') return alert('Already accepted');
    const vendor = users.find(u=>u.email===order.vendor);
    if(vendor){ vendor.balance += order.price; }
    order.status = 'accepted';
    order.adminApprovedAt = new Date().toISOString();
    persist();

    // try to start vendor live (if admin triggers while vendor is available)
    try{ startVendorLive(orderId); }catch(e){ /* ignore */ }

    alert('Admin approved and vendor credited');
    renderAdmin(users.find(u=>u.role==='admin'));
  };

  window.adminReject = function(orderId){
    const order = orders.find(o=>o.id===orderId);
    if(!order) return alert('Order not found');
    if(order.status==='rejected') return alert('Already rejected');
    const customer = users.find(u=>u.email===order.customer);
    if(customer){ customer.balance += order.price; }
    order.status = 'rejected';
    order.adminRejectedAt = new Date().toISOString();
    persist();
    alert('Admin rejected and customer refunded');
    renderAdmin(users.find(u=>u.role==='admin'));
  };

  /* LIVE TRACKING functions using watchPosition */
  function startVendorLive(orderId){
    if(liveWatchers.vendor[orderId]) return; // already watching
    if(!navigator.geolocation) return alert('Geolocation not supported');
    const watchId = navigator.geolocation.watchPosition(pos=>{
      const o = orders.find(x=>x.id===orderId); if(!o) return;
      o.vendorLocation = {lat:pos.coords.latitude,lng:pos.coords.longitude,ts:Date.now()};
      o.vendorLive = true; persist();
      if(currentMapOrder && currentMapOrder.id===orderId) updateMapForOrder(currentMapOrder);
    }, err=>{ console.warn('watch error',err); }, {enableHighAccuracy:true,maximumAge:5000,timeout:10000});
    liveWatchers.vendor[orderId]=watchId;
  }

  function stopVendorLive(orderId){
    const id = liveWatchers.vendor[orderId];
    if(id!=null){ navigator.geolocation.clearWatch(id); delete liveWatchers.vendor[orderId]; const o=orders.find(x=>x.id===orderId); if(o){ o.vendorLive=false; persist(); } }
  }

  function startCustomerLive(orderId){
    if(liveWatchers.customer[orderId]) return;
    if(!navigator.geolocation) return alert('Geolocation not supported');
    const watchId = navigator.geolocation.watchPosition(pos=>{
      const o = orders.find(x=>x.id===orderId); if(!o) return;
      o.customerLocation = {lat:pos.coords.latitude,lng:pos.coords.longitude,ts:Date.now()};
      o.customerLive = true; persist();
      if(currentMapOrder && currentMapOrder.id===orderId) updateMapForOrder(currentMapOrder);
    }, err=>{ console.warn('watch err',err); }, {enableHighAccuracy:true,maximumAge:5000,timeout:10000});
    liveWatchers.customer[orderId]=watchId;
    alert('Started sharing your live location for this order');
    renderCustomer(users.find(u=>u.id===session.userId));
  }

  function stopCustomerLive(orderId){
    const id = liveWatchers.customer[orderId];
    if(id!=null){ navigator.geolocation.clearWatch(id); delete liveWatchers.customer[orderId]; const o=orders.find(x=>x.id===orderId); if(o){ o.customerLive=false; persist(); } alert('Stopped sharing live location'); renderCustomer(users.find(u=>u.id===session.userId)); }
  }

  // helper to stop all live watchers for current user when sign out
  function stopAllLiveWatchersForUser(user){
    orders.forEach(o=>{
      if(o.vendor===user.email && liveWatchers.vendor[o.id]){ navigator.geolocation.clearWatch(liveWatchers.vendor[o.id]); delete liveWatchers.vendor[o.id]; }
      if(o.customer===user.email && liveWatchers.customer[o.id]){ navigator.geolocation.clearWatch(liveWatchers.customer[o.id]); delete liveWatchers.customer[o.id]; }
    });
  }

  // restore watchers when user signs back in during same session
  function restoreLiveWatchers(){
    if(!session) return;
    const user = users.find(u=>u.id===session.userId);
    if(!user) return;
    if(user.role==='vendor'){
      orders.filter(o=>o.vendor===user.email && o.status==='accepted').forEach(o=>startVendorLive(o.id));
    }
    if(user.role==='customer'){
      orders.filter(o=>o.customer===user.email && (o.status==='pending_vendor' || o.status==='accepted')).forEach(o=>{ if(o.customerLive) startCustomerLive(o.id); });
    }
  }

  // MAP UI
  let map, vendorMarker, customerMarker, currentMapOrder = null;
  function openMapModal(){ $('#mapModal').style.display='flex'; }
  function closeMapModal(){ $('#mapModal').style.display='none'; }

  function openMapForVendor(orderId){
    const o = orders.find(x=>x.id===orderId); if(!o) return alert('Order not found');
    currentMapOrder = o; $('#mapTitle').textContent = `Order ${o.id} — Vendor view`; openMapModal(); ensureMapInitialized(); updateMapForOrder(o);
    $('#mapRefresh').onclick = ()=> updateMapForOrder(o);
    $('#mapStop').onclick = ()=>{ stopVendorLive(o.id); alert('Stopped vendor live'); };
    $('#mapClose').onclick = ()=>{ closeMapModal(); };
  }

  function openMapForCustomer(orderId){
    const o = orders.find(x=>x.id===orderId); if(!o) return alert('Order not found');
    currentMapOrder = o; $('#mapTitle').textContent = `Order ${o.id} — Customer view`; openMapModal(); ensureMapInitialized(); updateMapForOrder(o);
    $('#mapRefresh').onclick = ()=> updateMapForOrder(o);
    $('#mapStop').onclick = ()=>{ stopCustomerLive(o.id); alert('Stopped sharing your live location'); };
    $('#mapClose').onclick = ()=>{ closeMapModal(); };
  }

  function openMapForAdmin(orderId){
    const o = orders.find(x=>x.id===orderId); if(!o) return alert('Order not found');
    currentMapOrder = o; $('#mapTitle').textContent = `Order ${o.id} — Admin view`; openMapModal(); ensureMapInitialized(); updateMapForOrder(o);
    $('#mapRefresh').onclick = ()=> updateMapForOrder(o);
    $('#mapStop').onclick = ()=>{ stopVendorLive(o.id); stopCustomerLive(o.id); alert('Stopped live tracking for this order (admin)'); };
    $('#mapClose').onclick = ()=>{ closeMapModal(); };
  }

  function ensureMapInitialized(){ if(map) return; map = L.map('map').setView([0,0],2); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map); vendorMarker = L.marker([0,0]).addTo(map).bindPopup('Vendor'); customerMarker = L.marker([0,0]).addTo(map).bindPopup('Customer'); }

  function updateMapForOrder(order){ if(!map) return; const v = order.vendorLocation; const c = order.customerLocation; const points=[]; if(v){ vendorMarker.setLatLng([v.lat,v.lng]).bindPopup(`Vendor<br/>${new Date(v.ts).toLocaleString()}`); points.push([v.lat,v.lng]); } if(c){ customerMarker.setLatLng([c.lat,c.lng]).bindPopup(`Customer<br/>${new Date(c.ts).toLocaleString()}`); points.push([c.lat,c.lng]); } if(points.length) map.fitBounds(points,{maxZoom:15,padding:[50,50]}); }

  // getCurrentPosition helper
  function getCurrentPosition(options){ return new Promise((res,rej)=>{ if(!navigator.geolocation) return rej(new Error('Geolocation not supported')); navigator.geolocation.getCurrentPosition(res,rej,options||{enableHighAccuracy:true,timeout:10000}); }); }

  // util file to base64
  function fileToBase64(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=e=>res(e.target.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

  // small helper to escape HTML when opening new windows
  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, (s)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[s]); }

  // initial render
  renderAuth();

  // Expose debug
  window._LB = {users,products,orders,persist,liveWatchers};
  </script>
</body>
</html>
